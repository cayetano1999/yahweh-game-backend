parameters:
  - name: dockerfile
    type: string
    default: "**/Dockerfile"
  - name: buildContext
    type: string
    default: "."
  - name: registry
    type: string
    default: ""
  - name: repository
    type: string
    default: ""

steps:
  - checkout: self
    lfs: true
    persistCredentials: true
    clean: true

  - task: npmAuthenticate@0
    inputs:
      workingFile: .npmrc
  
  - task: Bash@3
    displayName: "git pull"
    inputs:
      targetType: 'inline'
      script: |
        git fetch
        git checkout main
        git pull origin main

  - task: Docker@2
    displayName: "Docker Build & Push"
    inputs:
      command: "buildAndPush"
      containerRegistry: ${{ parameters.registry }}
      repository: ${{ parameters.repository }}
      buildContext: ${{ parameters.buildContext }}
      Dockerfile: ${{ parameters.dockerfile }}
      tags: |
        $(Build.BuildNumber)
        latest